# 0) The mental model you need

**Identity** answers “who are you”
**Authentication** answers “prove it”
**Authorization** answers “what can you do”

On a single RHEL host, local identity and auth data lives here:

* `/etc/passwd` account directory with public info
  Format: `name:x:UID:GID:comment:home:shell`
* `/etc/shadow` password hashes and aging data
  Only root readable
* `/etc/group` group directory
  Format: `name:x:GID:member1,member2`
* `/etc/gshadow` secure group data
  Only root readable

You rarely edit these by hand on the exam. Use the supported tools.

Core tools you will master:

* Users: `useradd usermod userdel passwd chage chpasswd id getent lastlog`
* Groups: `groupadd groupmod groupdel gpasswd newgrp grpck`
* Sudo: `sudo visudo` and drop-ins in `/etc/sudoers.d/`

---

# 1) Create, delete, and modify local users

## Create users

Common creation patterns:

```bash
# Simple user with home
sudo useradd -m alice
echo 'alice:P@ssw0rd' | sudo chpasswd

# With comment and shell
sudo useradd -m -c "Alice Smith,IT,555-0100" -s /bin/bash alice

# With specific UID and home path
sudo useradd -u 2205 -m -d /srv/users/bob bob

# System user, no home, no login
sudo useradd -r -M -s /sbin/nologin svc_backup
```

Defaults live in `useradd -D` and `/etc/default/useradd`. Skeleton files in `/etc/skel` get copied into new homes.

**Verify creation**

```bash
getent passwd alice
id alice
ls -ld /home/alice
```

## Modify users

```bash
# Change shell and comment
sudo usermod -s /bin/bash -c "Primary test user" alice

# Move home and move contents
sudo usermod -m -d /data/alice alice

# Change primary group
sudo groupadd devs
sudo usermod -g devs alice
```

**Delete users**

```bash
# Remove account, keep home
sudo userdel alice

# Remove account and home
sudo userdel -r bob
```

Tip: if `userdel` complains about running processes, stop them first or kill the session. On exam day, do not hand-edit the files to “force it.”

---

# 2) Change passwords and adjust password aging

## Set or change a password

```bash
sudo passwd alice            # interactive
echo 'alice:NewP@ss' | sudo chpasswd
```

## Lock, unlock, and force change

```bash
sudo passwd -l alice         # lock login by password
sudo passwd -u alice         # unlock
sudo passwd -e alice         # expire password now
# Or:
sudo chage -d 0 alice        # force change at next login
```

## Set aging policy per user

```bash
# min=1 day, max=30, warn=5, inactivity=10, expire on a date
sudo chage -m 1 -M 30 -W 5 -I 10 -E 2025-12-31 alice
sudo chage -l alice          # show effective policy
```

## Set defaults for new users only

`/etc/login.defs` controls defaults stamped into new accounts:

```bash
# Examples you might set
PASS_MAX_DAYS 45
PASS_MIN_DAYS 1
PASS_WARN_AGE 7
```

Then create a new user and inspect:

```bash
sudo useradd newguy
sudo chage -l newguy
```

Note: existing users are unaffected by changes to `login.defs`. Use `chage` per user.

---

# 3) Create, delete, and modify groups and memberships

## Create, rename, delete groups

```bash
sudo groupadd ops
sudo groupmod -n ops_legacy ops
sudo groupdel ops_legacy
```

## Primary group vs supplementary groups

* **Primary** group is one GID in `/etc/passwd`. Files you create get this group by default.
* **Supplementary** groups are additional memberships.

### Add or replace memberships

```bash
# Add without dropping existing memberships
sudo usermod -aG wheel,ops alice

# Replace the entire supplementary list
sudo usermod -G ops alice
```

### Manage membership with gpasswd

```bash
sudo gpasswd -a alice ops    # add
sudo gpasswd -d alice ops    # delete
getent group ops
```

### Temporary primary group for a subshell

```bash
sudo -u alice newgrp ops
# now files created in this subshell have group ops
```

### Shared group directory with setgid

```bash
sudo groupadd collab
sudo install -d -m 2775 -o root -g collab /srv/collab
sudo usermod -aG collab alice
sudo -u alice touch /srv/collab/test
ls -l /srv/collab               # files inherit group collab
```

---

# 4) Configure superuser access

## Sudo the right way

Never edit `/etc/sudoers` directly. Always use:

```bash
sudo visudo                 # syntax-checked edit
```

On RHEL, the wheel rule usually exists. Confirm then grant:

```bash
sudo grep -E '^\s*%wheel' /etc/sudoers
sudo usermod -aG wheel alice
sudo -iu alice sudo -l     # list permissions for alice
```

## Restrict by command and use drop-ins

Drop-in files live under `/etc/sudoers.d/`. Names cannot have dots.

```bash
# Allow group svcops to run only systemctl status without password
echo '%svcops ALL=(ALL) NOPASSWD: /usr/bin/systemctl status' \
  | sudo tee /etc/sudoers.d/10-svcops

sudo visudo -c               # validate all sudoers files
```

More patterns:

```bash
# Single user, only install with dnf, not remove
echo 'bob ALL=(ALL) /usr/bin/dnf install, !/usr/bin/dnf remove' \
  | sudo tee /etc/sudoers.d/10-bob-dnf
```

Test like an examiner:

```bash
sudo -iu bob sudo dnf install -y nano
sudo -iu bob sudo dnf remove -y nano || echo "blocked as intended"
```

---

# 5) Verification and troubleshooting

## Verify identities and membership

```bash
id alice
groups alice
getent passwd alice
getent group ops
```

## Check database consistency

```bash
sudo pwck -r     # passwd and shadow check
sudo grpck -r    # group and gshadow check
```

## Last login info

```bash
lastlog -u alice
# clear a record if you must demonstrate it
sudo lastlog -C 0 -u alice
```

## Common pitfalls and how to avoid them

* `usermod -G` without `-a` wipes existing supplementary groups. Always use `-aG` to append.
* `userdel -r` removes the home directory. If you need the data, back it up first.
* Locking an account with `passwd -l` affects password auth. Keys or sudo may still work if permitted.
* Changing default aging in `login.defs` does not rewrite existing users. Use `chage` per user.
* Do not edit `/etc/sudoers` with a generic editor. Use `visudo` so you never break sudo.

---

# 6) Mini drills with answers

Try first, then peek.

## Drill A. Create a standard user correctly

**Task** create `u01` with home, bash shell, comment “Primary user,” set a password, verify.

**Answer**

```bash
sudo useradd -m -s /bin/bash -c "Primary user" u01
echo 'u01:P@ss!' | sudo chpasswd
getent passwd u01
ls -ld /home/u01
```

## Drill B. Lock, unlock, and force change

**Task** lock `u01`, verify lock, unlock, then force password change at next login.

**Answer**

```bash
sudo passwd -l u01 ; sudo passwd -S u01
sudo passwd -u u01 ; sudo passwd -S u01
sudo chage -d 0 u01 ; sudo chage -l u01
```

## Drill C. Group work

**Task** create groups `ops` and `audit`. Add `u01` to both without losing any group. Verify membership without logout.

**Answer**

```bash
sudo groupadd ops ; sudo groupadd audit
sudo usermod -aG ops,audit u01
id u01
getent group ops ; getent group audit
```

## Drill D. Replace supplementary groups

**Task** make `u01` a member of only `ops` as supplementary. Verify that `audit` is gone.

**Answer**

```bash
sudo usermod -G ops u01
id u01
```

## Drill E. Sudo via wheel

**Task** confirm wheel rule exists, add `u01` to wheel, run a root-only command.

**Answer**

```bash
sudo grep -E '^\s*%wheel' /etc/sudoers
sudo usermod -aG wheel u01
sudo -iu u01 sudo id -u
```

## Drill F. Command-restricted sudo

**Task** allow group `svcops` to run `systemctl status` without password. Create `u02`, add to `svcops`, and verify.

**Answer**

```bash
sudo groupadd svcops
echo '%svcops ALL=(ALL) NOPASSWD: /usr/bin/systemctl status' \
 | sudo tee /etc/sudoers.d/10-svcops
sudo visudo -c
sudo useradd -m u02
sudo usermod -aG svcops u02
sudo -iu u02 sudo /usr/bin/systemctl status sshd
sudo -iu u02 sudo /usr/bin/id || echo "blocked as intended"
```

## Drill G. Password aging defaults for new users

**Task** set defaults max 45, min 1, warn 7 for new accounts. Create `u03` and verify.

**Answer**

```bash
# In /etc/login.defs set:
# PASS_MAX_DAYS 45
# PASS_MIN_DAYS 1
# PASS_WARN_AGE 7
sudo useradd -m u03
sudo chage -l u03
```

## Drill H. Clean deletion

**Task** create `u04`, put a file in home, delete user once keeping home, recreate, then delete with home removed.

**Answer**

```bash
sudo useradd -m u04
sudo runuser -l u04 -c 'touch ~/keepme'
sudo userdel u04                 # keeps /home/u04
sudo useradd -m u04
sudo userdel -r u04              # removes /home/u04
```

---

# 7) One-page cheat sheet

**Users**

* Create `useradd -m -c "Comment" -s /bin/bash name`
* Modify `usermod -s /bin/bash -c "New" name`
* Delete `userdel [-r] name`
* Lock or expire `passwd -l|-u|-e name` or `chage -d 0 name`
* Aging `chage -m MIN -M MAX -W WARN -I INACT -E YYYY-MM-DD name`
* Verify `id name`, `getent passwd name`, `lastlog -u name`

**Groups**

* Create or rename `groupadd grp`, `groupmod -n new grp`
* Delete `groupdel grp`
* Membership `usermod -aG g1,g2 user` or `gpasswd -a user grp`
* Replace list `usermod -G g1 user`
* Temporary primary `newgrp grp`

**Sudo**

* Edit safely `visudo` or drop-ins `/etc/sudoers.d/`
* Grant wheel `usermod -aG wheel user`
* Test `sudo -l`, run command, keep logs clean

**Do not**

* Do not use `usermod -G` without `-a` unless you intend to replace all groups
* Do not edit `/etc/sudoers` with a normal editor
* Do not hand-edit passwd or group files on the exam

---

# 8) Quick “exam flow” patterns

* **Grant admin quickly**

  ```bash
  sudo useradd -m trainee
  echo 'trainee:P@ss!' | sudo chpasswd
  sudo usermod -aG wheel trainee
  sudo -iu trainee sudo id -u
  ```

* **Set strict per-user policy**

  ```bash
  sudo chage -m 1 -M 30 -W 5 -I 10 -E 2025-12-31 trainee
  sudo chage -l trainee
  ```

* **Shared project directory with enforced group**

  ```bash
  sudo groupadd proj
  sudo install -d -m 2775 -o root -g proj /data/proj
  sudo usermod -aG proj trainee
  ```

* **Minimal service account**

  ```bash
  sudo useradd -r -M -s /sbin/nologin svc_app
  id svc_app
  ```

