# 0) Mental model you actually need

* **Firewalld** controls inbound traffic by zone, service, or port. There are runtime vs permanent configs.
* **Default file permissions** come from `umask` and default ACLs. Get these right and you stop firefighting later.
* **SSH keys** replace passwords and make automation sane.
* **SELinux** is an allow list. Contexts label files and processes, booleans toggle safe policy exceptions, port labels map ports to types. You fix most problems with correct labels plus the right boolean.

Bias: use `firewall-cmd`, `semanage`, and `restorecon`. Verify with `ss`, `ls -Z`, `ps -eZ`, and `getenforce`.

---

# 1) Configure firewall settings with firewalld and firewall-cmd

Start and enable

```bash
sudo systemctl enable --now firewalld
firewall-cmd --state
```

Know your zones

```bash
firewall-cmd --get-default-zone
firewall-cmd --get-active-zones
firewall-cmd --zone=public --list-all
```

Put an interface in a zone and persist

```bash
IF=ens224
firewall-cmd --zone=public --change-interface="$IF"
# Also persist via NetworkManager so it survives profile flips
nmcli con mod "$(nmcli -t -f NAME,DEVICE con show | awk -F: -v d="$IF" '$2==d{print $1;exit}')" connection.zone public
```

Allow services and ports

```bash
firewall-cmd --zone=public --add-service=http            # runtime
firewall-cmd --permanent --zone=public --add-service=ssh # permanent
firewall-cmd --permanent --zone=public --add-port=8080/tcp
firewall-cmd --reload
firewall-cmd --zone=public --list-all
```

Limit access with rich rules

```bash
# Allow HTTP only from 192.0.2.0/24, drop the rest
firewall-cmd --permanent --zone=public \
  --add-rich-rule='rule family="ipv4" source address="192.0.2.0/24" service name="http" accept'
firewall-cmd --permanent --zone=public \
  --add-rich-rule='rule family="ipv4" service name="http" drop'
firewall-cmd --reload
```

Masquerade and simple forwarding

```bash
firewall-cmd --permanent --zone=public --add-masquerade
firewall-cmd --permanent --zone=public \
  --add-forward-port=port=8080:proto=tcp:toaddr=10.10.10.5:toport=80
firewall-cmd --reload
```

Runtime vs permanent sanity

```bash
firewall-cmd --zone=public --list-all                 # runtime
firewall-cmd --zone=public --list-all --permanent     # stored
```

---

# 2) Manage default file permissions

Instant defaults in your shell

```bash
umask           # typical 0022 or 0027
umask 027       # new files 640, new dirs 750
```

Make shared directories behave

```bash
# setgid so files inherit the group
sudo install -d -m 2775 -o root -g dev /srv/shared
# default ACL so group writes by default
sudo setfacl -m d:g:dev:rwx /srv/shared
getfacl /srv/shared
```

System wide defaults you should know

* Login shells source `/etc/profile`, `/etc/bashrc`, and `~/.bashrc`. These can set a system umask.
* PAM can set umask via `pam_umask.so` and `UMASK` in `/etc/login.defs`. RHCSA tends to test per shell `umask`, not PAM surgery.

---

# 3) Configure key-based authentication for SSH

Generate and install a key

```bash
ssh-keygen -t ed25519 -C "lab" -f ~/.ssh/id_ed25519
ssh-copy-id user@serverB
```

Harden the server

```bash
# /etc/ssh/sshd_config
PubkeyAuthentication yes
PasswordAuthentication no
PermitRootLogin no
# then:
sudo systemctl restart sshd
```

Permissions and SELinux for keys

```bash
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
restorecon -Rv ~/.ssh
```

Firewall

```bash
firewall-cmd --permanent --add-service=ssh
firewall-cmd --reload
```

Test

```bash
ssh -i ~/.ssh/id_ed25519 user@serverB
```

---

# 4) SELinux modes

Check and toggle

```bash
getenforce            # Enforcing or Permissive
sudo setenforce 0     # Permissive now
sudo setenforce 1     # Enforcing now
sestatus
```

Make persistent

```bash
# /etc/selinux/config
SELINUX=enforcing     # or permissive
SELINUXTYPE=targeted
```

When you change the root password with rd.break, remember to `touch /.autorelabel` so SELinux fixes labels on next boot.

---

# 5) List and identify SELinux contexts

Install admin tools if missing

```bash
sudo dnf -y install policycoreutils-python-utils
```

See contexts on files and processes

```bash
ls -Z /var/www/html
ps -eZ | grep httpd
id -Z
```

See the default type for a path

```bash
semanage fcontext -l | grep -E '/var/www|/srv/www'
matchpathcon /srv/www/index.html
```

---

# 6) Restore default file contexts

The move that fixes most SELinux file issues

```bash
sudo restorecon -Rv /var/www/html
```

Set or change defaults for a path, then restore

```bash
# label all of /srv/www as httpd content
sudo semanage fcontext -a -t httpd_sys_content_t '/srv/www(/.*)?'
sudo restorecon -Rv /srv/www
```

If things are really messy

```bash
sudo fixfiles onboot
# or
sudo fixfiles -F restore
```

---

# 7) Manage SELinux port labels

List and add

```bash
semanage port -l | grep http_port_t
sudo semanage port -a -t http_port_t -p tcp 8080
semanage port -l | grep 8080
```

Remove

```bash
sudo semanage port -d -t http_port_t -p tcp 8080
```

Remember the trio when you run a service on a new port:

1. firewall port open,
2. SELinux port label,
3. the service actually listening there.

---

# 8) Use SELinux booleans

List with descriptions

```bash
semanage boolean -l | head
getsebool -a | head
```

Common httpd examples

```bash
# allow httpd to make outbound connections, for proxies or app calls
sudo setsebool -P httpd_can_network_connect on
# allow user home dirs to be served if using userdir
sudo setsebool -P httpd_enable_homedirs on
# allow httpd to connect to databases over the network
sudo setsebool -P httpd_can_network_connect_db on
```

NFS and Samba examples

```bash
# allow services to read NFS content
sudo setsebool -P nfs_export_all_ro on
# allow Samba to share home directories
sudo setsebool -P samba_enable_home_dirs on
```

Verify

```bash
getsebool httpd_can_network_connect
```

---

# 9) Troubleshooting patterns that actually work

* If access is denied, read the denial

  ```bash
  journalctl -t setroubleshoot -b | tail -n +1 2>/dev/null || true
  ausearch -m AVC,USER_AVC -ts recent | aureport -a
  ```

  Then either fix the label with `restorecon`, add the right port label with `semanage port`, or flip a boolean with `setsebool -P`.

* For NFS and VFAT, check server side or mount options first. Local `chmod` will not override read-only exports or a VFAT `umask`.

* For firewalld, keep runtime vs permanent in your head. If you use `--permanent`, you must `--reload`.

Tiny humor break: SELinux is not angry with you. It is disappointed in your labels.

---

# 10) Labs first, solutions after

Work on your RHEL box. Do not peek.

## A. firewalld

1. Put interface `ens224` in the `public` zone persistently.
2. Allow `ssh` permanently and `http` runtime only. Add port `8080/tcp` permanently. Reload and verify runtime vs permanent.
3. Allow HTTP only from `192.0.2.0/24`, drop everyone else.

## B. Default permissions

4. Set your shell `umask` to `027`. Create `secrets.txt` and prove its mode.
5. Create `/srv/shared` setgid with group `dev`, and default ACL for group `dev` to have `rwx`. Prove a new file inherits group and permissions.

## C. SSH keys

6. Generate an ed25519 key, copy it to `user@serverB`, and disable password authentication on the server. Fix `.ssh` permissions and contexts. Verify login with the key.

## D. SELinux mode

7. Switch to Permissive, verify, then back to Enforcing. Make it Enforcing in `/etc/selinux/config`.

## E. SELinux contexts and booleans

8. Serve content from `/srv/www` with httpd. Label it correctly, start httpd, and prove you can read a file via `curl` locally.
9. Configure httpd to listen on `8080`. Open the firewall, add the SELinux port label, restart httpd, and access it.
10. Enable `httpd_can_network_connect` and show it is on.

## F. Restore contexts and diagnose

11. Break labels under `/srv/www` by copying files from `/root`, then fix them properly.
12. Show an AVC denial, explain the fix in one line, then apply it.

---

# Solution key

## A. firewalld

```bash
# 1
IF=ens224
firewall-cmd --zone=public --change-interface="$IF"
nmcli con mod "$(nmcli -t -f NAME,DEVICE con show | awk -F: -v d="$IF" '$2==d{print $1;exit}')" connection.zone public

# 2
firewall-cmd --permanent --zone=public --add-service=ssh
firewall-cmd --zone=public --add-service=http
firewall-cmd --permanent --zone=public --add-port=8080/tcp
firewall-cmd --reload
echo "Runtime:"; firewall-cmd --zone=public --list-services
echo "Permanent:"; firewall-cmd --zone=public --list-services --permanent
firewall-cmd --zone=public --list-ports
firewall-cmd --zone=public --list-ports --permanent

# 3
firewall-cmd --permanent --zone=public \
  --add-rich-rule='rule family="ipv4" source address="192.0.2.0/24" service name="http" accept'
firewall-cmd --permanent --zone=public \
  --add-rich-rule='rule family="ipv4" service name="http" drop'
firewall-cmd --reload
firewall-cmd --zone=public --list-rich-rules
```

## B. Default permissions

```bash
# 4
umask 027
touch secrets.txt
stat -c '%a %n' secrets.txt   # 640 expected

# 5
sudo groupadd -f dev
sudo install -d -m 2775 -o root -g dev /srv/shared
sudo setfacl -m d:g:dev:rwx /srv/shared
sudo usermod -aG dev "$USER"
newgrp dev <<'EOF'
touch /srv/shared/testfile
ls -l /srv/shared/testfile
getfacl /srv/shared/testfile | grep -E 'group:dev|default'
EOF
```

## C. SSH keys

```bash
ssh-keygen -t ed25519 -C "lab" -f ~/.ssh/id_ed25519
ssh-copy-id user@serverB

# Server hardening
sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sudo systemctl restart sshd

# Permissions and contexts
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
restorecon -Rv ~/.ssh

ssh -i ~/.ssh/id_ed25519 user@serverB
```

## D. SELinux mode

```bash
getenforce
sudo setenforce 0
getenforce   # Permissive
sudo setenforce 1
getenforce   # Enforcing
# Persistent
sudo sed -i 's/^SELINUX=.*/SELINUX=enforcing/' /etc/selinux/config
```

## E. Contexts, ports, booleans

```bash
# 8 serve from /srv/www
sudo dnf -y install httpd
sudo mkdir -p /srv/www
echo "hello" | sudo tee /srv/www/index.html
sudo semanage fcontext -a -t httpd_sys_content_t '/srv/www(/.*)?'
sudo restorecon -Rv /srv/www
sudo sed -i 's|^DocumentRoot .*|DocumentRoot "/srv/www"|' /etc/httpd/conf/httpd.conf
sudo systemctl enable --now httpd
curl -I http://127.0.0.1 2>/dev/null | head -n1

# 9 move httpd to port 8080 with correct labels and firewall
echo 'Listen 8080' | sudo tee /etc/httpd/conf.d/zz-8080.conf
sudo semanage port -a -t http_port_t -p tcp 8080
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload
sudo systemctl restart httpd
ss -lntp | grep ':8080 '
curl -I http://127.0.0.1:8080 2>/dev/null | head -n1

# 10 boolean
sudo setsebool -P httpd_can_network_connect on
getsebool httpd_can_network_connect
```

## F. Restore and diagnose

```bash
# 11 break then fix
sudo cp /root/.bashrc /srv/www/.bashrc
ls -Z /srv/www/.bashrc
sudo restorecon -Rv /srv/www
ls -Z /srv/www/.bashrc

# 12 show a denial and fix quickly
# Example: try to have httpd read from /root/test.txt, watch denial
sudo journalctl -t setroubleshoot -b | tail -n +1 2>/dev/null || true
# Generic fix patterns:
# - for wrong file type: semanage fcontext -a -t <type> 'PATH(/.*)?' && restorecon -Rv PATH
# - for new outbound network use: setsebool -P httpd_can_network_connect on
```

---

## One page cheat sheet

* **firewalld**
  `--get-active-zones`
  `--zone=public --add-service=http`
  `--permanent ... --add-port=8080/tcp; --reload`
  Rich rule allow subnet then drop others for same service
* **defaults**
  `umask 027`
  Shared dir: `chmod 2775 dir` and `setfacl -m d:g:grp:rwx dir`
* **SSH keys**
  `ssh-keygen -t ed25519`
  `ssh-copy-id user@host`
  `PasswordAuthentication no`
  Fix perms and `restorecon -Rv ~/.ssh`
* **SELinux modes**
  `getenforce`, `setenforce 0|1`
  Persistent in `/etc/selinux/config`
* **Contexts**
  Files: `ls -Z`, Processes: `ps -eZ`
  Set default type: `semanage fcontext -a -t TYPE 'PATH(/.*)?'` then `restorecon -Rv PATH`
* **Ports**
  `semanage port -a -t http_port_t -p tcp 8080`
* **Booleans**
  List: `semanage boolean -l`
  Set: `setsebool -P httpd_can_network_connect on`
* **Debug**
  Read denials with `journalctl -b | grep AVC` or `ausearch -m AVC` and apply label, port, or boolean fix

