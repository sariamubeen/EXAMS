
# 0) Mental model you actually need

* **Disks → Partitions → PVs → VGs → LVs → Filesystems → Mounts**
* MBR and GPT are partition table types. GPT is modern and safer. Use GPT unless told otherwise.
* LVM lets you pool disks (PVs) into volume groups (VGs) and carve out logical volumes (LVs) you can grow online.
* Filesystems: on RHCSA you mostly see **XFS** and sometimes **ext4**. XFS grows online, never shrinks. ext4 grows online, shrinks offline.
* Mount at boot with **UUID** or **LABEL** in `/etc/fstab`. Test with `mount -a` before you reboot, or you learn lessons the hard way.

Opinionated but true: prefer GPT, prefer LVM on top, prefer XFS for general purpose mounts.

---

# 1) Inspect storage like a pro

```bash
lsblk -e7 -o NAME,SIZE,TYPE,FSTYPE,MOUNTPOINT,UUID
lsblk -f                       # quick FSTYPE + UUID view
blkid                          # all UUIDs and LABELs
sudo fdisk -l /dev/vdb         # MBR/GPT view with sectors
sudo parted -l                 # nice GPT summaries
cat /proc/partitions
```

Replace `/dev/vdb` with your exam disk. Do not practice on `/dev/sda` if it holds your OS.

---

# 2) Partitioning: MBR and GPT

You can use `fdisk` for both MBR and GPT. `parted` also works and is very fast for GPT.

## Create a GPT disk with one LVM partition (parted)

```bash
DISK=/dev/vdb
sudo parted -s "$DISK" mklabel gpt
sudo parted -s "$DISK" mkpart pv01 1MiB 100%      # use free space
sudo parted -s "$DISK" set 1 lvm on
sudo partprobe "$DISK"                             # inform kernel
```

## Create an MBR disk with one LVM partition (fdisk)

```bash
DISK=/dev/vdc
sudo fdisk "$DISK" <<'EOF'
o             # new DOS label (MBR)
n             # new partition
p             # primary
1             # number
              # default start
              # default end = rest of disk
t             # change type
8e            # Linux LVM
w
EOF
sudo partprobe "$DISK"
```

Helpful prints:

```bash
sudo fdisk -l "$DISK"
sudo parted "$DISK" print free
```

---

# 3) LVM essentials

## Create PV → VG → LV

```bash
PV=/dev/vdb1
VG=vgdata
LV=data

sudo pvcreate "$PV"
sudo vgcreate "$VG" "$PV"
sudo lvcreate -n "$LV" -L 5G "$VG"          # size by absolute value
# or use all remaining free space:
# sudo lvcreate -n "$LV" -l 100%FREE "$VG"
```

List and verify:

```bash
pvs; vgs; lvs -a -o +seg_monitor
sudo vgdisplay "$VG"
sudo lvdisplay "/dev/$VG/$LV"
```

## Add another PV later

```bash
sudo pvcreate /dev/vdc1
sudo vgextend "$VG" /dev/vdc1
vgs
```

## Remove safely

```bash
sudo lvremove /dev/$VG/$LV
sudo vgreduce "$VG" /dev/vdc1
sudo pvremove /dev/vdc1
```

Advanced but useful: move data off a PV before removing:

```bash
sudo pvmove /dev/vdc1
sudo vgreduce "$VG" /dev/vdc1
```

---

# 4) Filesystems and labels

Create XFS or ext4:

```bash
sudo mkfs.xfs  -L DATA01 /dev/$VG/$LV
# or
sudo mkfs.ext4 -L DATA01 /dev/$VG/$LV
```

Swap:

```bash
sudo mkswap -L SWAP01 /dev/$VG/swaplv
```

Labels after the fact:

```bash
sudo xfs_admin -L NEWLABEL /dev/$VG/$LV         # XFS
sudo e2label /dev/$VG/$LV NEWLABEL              # ext4
sudo swaplabel -L NEWSWAP /dev/$VG/swaplv
```

Find UUIDs:

```bash
blkid /dev/$VG/$LV
lsblk -f
```

---

# 5) Mount at boot by UUID or LABEL

Create a mount and validate:

```bash
sudo mkdir -p /data
# Find UUID first
UUID=$(blkid -s UUID -o value /dev/$VG/$LV)
echo "UUID=$UUID  /data  xfs  defaults  0 0" | sudo tee -a /etc/fstab
sudo mount -a
findmnt /data
```

Using LABEL is similar:

```bash
echo "LABEL=DATA01 /data xfs defaults 0 0" | sudo tee -a /etc/fstab
sudo mount -a
```

Swap in fstab:

```bash
echo "UUID=$(blkid -s UUID -o value /dev/$VG/swaplv)  none  swap  defaults  0 0" | sudo tee -a /etc/fstab
sudo swapon -a
swapon --show
```

Pro tip: always `mount -a` after editing fstab. If it errors, fix it now, not after a reboot.

---

# 6) Grow logical volumes and filesystems online

### XFS

```bash
sudo lvextend -r -L +2G /dev/$VG/$LV          # -r auto grows FS if supported
# or without -r:
sudo lvextend -L +2G /dev/$VG/$LV
sudo xfs_growfs /data                         # grow by mountpoint
```

### ext4

```bash
sudo lvextend -L +2G /dev/$VG/$LV
sudo resize2fs /dev/$VG/$LV                   # online grow if mounted rw
```

Shrinking:

* **XFS** cannot shrink. Plan ahead.
* **ext4** can shrink but requires the FS unmounted or mounted read-only. Not typical in RHCSA tasks.

---

# 7) Add new partitions, LVs, and swap non-destructively

Non-destructive translates to “use free space or new disks, do not wipe existing data, and grow online.”

Pattern:

1. Create a new partition in unused space.
2. `pvcreate` the new partition.
3. `vgextend` to add it to an existing VG.
4. `lvextend` and grow the filesystem online.
5. For swap, create a new LV or partition, mkswap, `swapon`, add to fstab.

Example quick path:

```bash
# 1) carve free space on /dev/vdb into /dev/vdb2 (using parted or fdisk)
sudo parted -s /dev/vdb mkpart pv02 100GiB 150GiB
sudo parted -s /dev/vdb set 2 lvm on

# 2..4) add to LVM and extend
sudo pvcreate /dev/vdb2
sudo vgextend vgdata /dev/vdb2
sudo lvextend -r -L +10G /dev/vgdata/data

# 5) add swap LV
sudo lvcreate -n swaplv -L 2G vgdata
sudo mkswap -L SWAP02 /dev/vgdata/swaplv
echo "UUID=$(blkid -s UUID -o value /dev/vgdata/swaplv) none swap defaults 0 0" | sudo tee -a /etc/fstab
sudo swapon -a
swapon --show
```

Zero downtime for the data LV, and swap goes live without reboot.

---

# 8) Cleanup tools and safety

* Test mounts: `mount -a` then `findmnt`.
* Check LVM integrity: `vgck vgdata` and `pvck /dev/vdb1` if you suspect issues.
* Remove stale fstab entries with care. Use `nofail` for removable disks:

  ```
  UUID=...  /mnt/usb  xfs  nofail,x-systemd.device-timeout=5  0 0
  ```

Tiny humor break: fstab is like gravity. Always on, unforgiving if you get it wrong.

---

# 9) Labs first, solutions after

Use a spare disk like `/dev/vdb` and optionally `/dev/vdc`. Do not touch your OS disk.

## A. Partition basics

1. On `/dev/vdb`, create a **GPT** label and one partition using all free space, flagged for LVM.
2. On `/dev/vdc`, create an **MBR** label and one primary partition of 2 GiB, type LVM.

## B. Build LVM

3. Create a PV on `/dev/vdb1`, make VG `vgapps`, then LV `logs` of 3G.
4. Create an XFS filesystem on `logs` labeled `LOGS01` and mount at `/var/log/custom`. Persist by **LABEL**.
5. Verify with `lsblk -f`, `findmnt`, and a reboot-safe `mount -a`.

## C. Grow online

6. Add `/dev/vdc1` to `vgapps` and extend `logs` by 2G. Grow the filesystem online and prove the size increased.

## D. ext4 variant

7. Create LV `data` of 2G in `vgapps`, format as ext4 labeled `DATA01`, mount at `/data`. Persist by **UUID**.
8. Extend `data` by 1G and grow ext4 online.

## E. Swap

9. Create LV `swaplv` of 1G in `vgapps`, make it swap labeled `SWAP01`, enable it, and persist at boot.
10. Show active swap and the fstab line.

## F. Non-destructive expansion

11. Create a new partition in remaining space on `/dev/vdb`, convert to PV, `vgextend vgapps`, and extend LV `data` by all free extents. Grow the FS online without unmounting.
12. Practice `pvmove` by moving all data off `/dev/vdc1` to other PVs, then remove `/dev/vdc1` from the VG without downtime.

---

# SOLUTION KEY

## A. Partition basics

```bash
# 1
DISK=/dev/vdb
sudo parted -s "$DISK" mklabel gpt
sudo parted -s "$DISK" mkpart pv01 1MiB 100%
sudo parted -s "$DISK" set 1 lvm on
sudo partprobe "$DISK"
sudo parted "$DISK" print

# 2
DISK=/dev/vdc
sudo fdisk "$DISK" <<'EOF'
o
n
p
1


+2G
t
8e
w
EOF
sudo partprobe "$DISK"
sudo fdisk -l "$DISK"
```

## B. Build LVM

```bash
sudo pvcreate /dev/vdb1
sudo vgcreate vgapps /dev/vdb1
sudo lvcreate -n logs -L 3G vgapps

sudo mkfs.xfs -L LOGS01 /dev/vgapps/logs
sudo mkdir -p /var/log/custom
echo "LABEL=LOGS01 /var/log/custom xfs defaults 0 0" | sudo tee -a /etc/fstab
sudo mount -a
lsblk -f | grep LOGS01
findmnt /var/log/custom
```

## C. Grow online

```bash
sudo pvcreate /dev/vdc1
sudo vgextend vgapps /dev/vdc1
sudo lvextend -r -L +2G /dev/vgapps/logs
df -h /var/log/custom
```

## D. ext4 variant

```bash
sudo lvcreate -n data -L 2G vgapps
sudo mkfs.ext4 -L DATA01 /dev/vgapps/data
sudo mkdir -p /data
UUID=$(blkid -s UUID -o value /dev/vgapps/data)
echo "UUID=$UUID /data ext4 defaults 0 0" | sudo tee -a /etc/fstab
sudo mount -a
findmnt /data

# grow by 1G
sudo lvextend -L +1G /dev/vgapps/data
sudo resize2fs /dev/vgapps/data
df -h /data
```

## E. Swap

```bash
sudo lvcreate -n swaplv -L 1G vgapps
sudo mkswap -L SWAP01 /dev/vgapps/swaplv
echo "UUID=$(blkid -s UUID -o value /dev/vgapps/swaplv) none swap defaults 0 0" | sudo tee -a /etc/fstab
sudo swapon -a
swapon --show
```

## F. Non-destructive expansion

```bash
# 11 create another PV in free space on /dev/vdb
sudo parted -s /dev/vdb mkpart pv02 100GiB 100%        # example endpoints
sudo parted -s /dev/vdb set 2 lvm on
sudo pvcreate /dev/vdb2
sudo vgextend vgapps /dev/vdb2
sudo lvextend -r -l +100%FREE /dev/vgapps/data
df -h /data

# 12 migrate then remove /dev/vdc1
sudo pvmove /dev/vdc1
sudo vgreduce vgapps /dev/vdc1
sudo pvremove /dev/vdc1
vgs; pvs
```

---

## One-page cheat sheet

* Inspect
  `lsblk -f` • `blkid` • `parted -l` • `fdisk -l`
* Partition
  GPT: `parted mklabel gpt; mkpart; set 1 lvm on`
  MBR: `fdisk` type 8e for LVM
* LVM
  `pvcreate /dev/vdb1` • `vgcreate vgX /dev/vdb1` • `lvcreate -n lv -L 5G vgX`
  `vgextend vgX /dev/vdc1` • `lvextend -r -L +2G /dev/vgX/lv`
  `pvmove /dev/vdc1` • `vgreduce vgX /dev/vdc1` • `pvremove`
* Filesystems
  `mkfs.xfs -L LABEL /dev/vg/lv` • `mkfs.ext4 -L LABEL /dev/vg/lv`
  `xfs_admin -L NEW /dev/vg/lv` • `e2label /dev/vg/lv NEW`
* Mount at boot
  `/etc/fstab`: `UUID=<uuid> /mnt xfs defaults 0 0`
  Test: `mount -a` • Verify: `findmnt`
* Grow online
  XFS: `lvextend -L +N -r` or `xfs_growfs /mount`
  ext4: `lvextend -L +N` then `resize2fs /dev/vg/lv`
* Swap
  `lvcreate -n swaplv -L 2G vgX` • `mkswap -L SWAP01 /dev/vgX/swaplv`
  `/etc/fstab`: `UUID=<uuid> none swap defaults 0 0` • `swapon -a`

